{% extends "base.html" %}
{% block conteudo %}
<div class="container" style="margin-top: 28px; margin-bottom: 80px;">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center flex-wrap mb-3">
    <div>
      <h4 class="fw-bold text-primary mb-1"><i class="bi bi-graph-up-arrow me-2"></i>Painel Geral — NTI</h4>
      <p class="text-muted mb-0">Visão consolidada dos chamados de todos os setores.</p>
    </div>

    <div class="d-flex gap-2 flex-wrap">
      <a href="{{ url_for('painel') }}" class="btn btn-primary btn-sm">
        <i class="bi bi-grid-3x3-gap-fill"></i> Ir para Painel
      </a>
      <a href="{{ url_for('backup_excel') }}" class="btn btn-secondary btn-sm">
        <i class="bi bi-download"></i> Fazer Backup
      </a>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row g-3 mb-4">
    <div class="col-md-3 col-sm-6">
      <div class="card text-white shadow-sm text-center" style="background:#2563eb;">
        <div class="card-body py-3">
          <h6 class="fw-normal mb-1">Abertos</h6>
          <h3 id="kpiAbertosVal" class="fw-bold">0</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="card text-white shadow-sm text-center" style="background:#f59e0b;">
        <div class="card-body py-3">
          <h6 class="fw-normal mb-1">Em andamento</h6>
          <h3 id="kpiAndamentoVal" class="fw-bold">0</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="card text-white shadow-sm text-center" style="background:#10b981;">
        <div class="card-body py-3">
          <h6 class="fw-normal mb-1">Finalizados</h6>
          <h3 id="kpiFinalizadosVal" class="fw-bold">0</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="card text-white shadow-sm text-center" style="background:#111827;">
        <div class="card-body py-3">
          <h6 class="fw-normal mb-1">Total</h6>
          <h3 id="kpiTotalVal" class="fw-bold">0</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts -->
  <div class="row g-3 mb-4">
    <div class="col-md-6">
      <div class="card shadow-sm" style="height: 360px;">
        <div class="card-body d-flex flex-column justify-content-center align-items-center">
          <h6 class="fw-bold mb-3 w-100 text-start">Distribuição por Status</h6>
          <canvas id="chartStatus" style="max-height:280px;"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card shadow-sm" style="height: 360px;">
        <div class="card-body">
          <h6 class="fw-bold mb-3">Chamados por Setor</h6>
          <canvas id="chartSetor" style="max-height:280px;"></canvas>
        </div>
      </div>
    </div>
    <div class="col-12">
      <div class="card shadow-sm" style="height: 320px;">
        <div class="card-body">
          <h6 class="fw-bold mb-3">Evolução (últimos 30 dias)</h6>
          <canvas id="chartDia" style="max-height:250px;"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabela -->
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center flex-wrap mb-3">
        <h5 class="fw-bold mb-2 mb-md-0">Últimos chamados</h5>
        <input id="busca" type="text" placeholder="Filtrar..." class="form-control form-control-sm" style="max-width:220px;">
      </div>

      <div class="table-responsive">
        <table class="table table-hover align-middle text-center">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>Setor Solicitante</th>
              <th>Setor Responsável</th>
              <th>Local</th>
              <th>Descrição</th>
              <th>Prioridade</th>
              <th>Status</th>
              <th>Abertura</th>
              <th style="width:60px;">Ações</th>
            </tr>
          </thead>
          <tbody id="tbody">
            {% for c in ultimos %}
            <tr>
              <td><strong>#{{ c.id }}</strong></td>
              <td>{{ c.setor_abertura or '—' }}</td>
              <td>{{ c.setor_responsavel }}</td>
              <td>{{ c.local }}</td>
              <td class="text-start" style="max-width:420px; white-space:normal;">
                {% set desc = c.descricao %}
                {% if desc|length > 100 %}
                  <span class="descricao-curta">{{ desc[:100] }}...</span>
                  <span class="descricao-completa d-none">{{ desc }}</span>
                  <a href="#" class="btn-vermais small fw-semibold text-primary text-decoration-none">Ver mais</a>
                {% else %}
                  {{ desc }}
                {% endif %}
              </td>
              <td>
                {% if c.prioridade == 'vermelho' %}
                  <span class="badge bg-danger">Urgente</span>
                {% elif c.prioridade == 'amarelo' %}
                  <span class="badge bg-warning text-dark">Média</span>
                {% else %}
                  <span class="badge bg-success">Normal</span>
                {% endif %}
              </td>
              <td>
                <span class="badge 
                  {% if c.status == 'aberto' %} bg-secondary 
                  {% elif c.status == 'em andamento' %} bg-warning text-dark 
                  {% else %} bg-success {% endif %}">
                  {{ c.status.capitalize() }}
                </span>
              </td>
              <td>{{ c.criado_em }}</td>
              <td>
                <form method="post" action="{{ url_for('excluir', cid=c.id) }}" 
                      onsubmit="return confirm('Deseja realmente excluir este chamado?');">
                  <button type="submit" class="btn btn-link p-0" style="color:#dc2626;">
                    <i class="bi bi-trash3-fill fs-5"></i>
                  </button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
async function loadOverview() {
  const r = await fetch('/api/dashboard/overview');
  if (!r.ok) return;
  const d = await r.json();
  document.getElementById('kpiAbertosVal').textContent = d.abertos ?? 0;
  document.getElementById('kpiAndamentoVal').textContent = d.andamento ?? 0;
  document.getElementById('kpiFinalizadosVal').textContent = d.finalizados ?? 0;
  document.getElementById('kpiTotalVal').textContent = d.total ?? 0;

  new Chart(document.getElementById('chartStatus'), {
    type: 'doughnut',
    data: {
      labels: ['Abertos', 'Em andamento', 'Finalizados'],
      datasets: [{
        data: [d.abertos, d.andamento, d.finalizados],
        backgroundColor: ['#2563eb', '#f59e0b', '#10b981'],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      cutout: '60%',
      plugins: { legend: { position: 'bottom' } }
    }
  });
}

async function loadBySector() {
  const r = await fetch('/api/dashboard/by_sector');
  if (!r.ok) return;
  const d = await r.json();
  new Chart(document.getElementById('chartSetor'), {
    type: 'bar',
    data: { labels: d.labels, datasets: [{ label: 'Chamados', data: d.values, backgroundColor: '#2563eb' }] },
    options: { responsive: true, maintainAspectRatio: true, scales: { y: { beginAtZero: true } } }
  });
}

async function loadByDay() {
  const r = await fetch('/api/dashboard/by_day');
  if (!r.ok) return;
  const d = await r.json();
  new Chart(document.getElementById('chartDia'), {
    type: 'line',
    data: { labels: d.labels, datasets: [{ label: 'Chamados', data: d.values, borderColor: '#2563eb', tension: 0.3 }] },
    options: { responsive: true, maintainAspectRatio: true, scales: { y: { beginAtZero: true } } }
  });
}

document.getElementById('busca').addEventListener('input', e => {
  const termo = e.target.value.toLowerCase();
  document.querySelectorAll('#tbody tr').forEach(tr => {
    tr.style.display = tr.innerText.toLowerCase().includes(termo) ? '' : 'none';
  });
});

document.addEventListener("click", function(e) {
  if (e.target.classList.contains("btn-vermais")) {
    e.preventDefault();
    const curta = e.target.previousElementSibling.previousElementSibling;
    const completa = e.target.previousElementSibling;
    const expandido = !completa.classList.contains("d-none");
    if (expandido) {
      completa.classList.add("d-none");
      curta.classList.remove("d-none");
      e.target.textContent = "Ver mais";
    } else {
      completa.classList.remove("d-none");
      curta.classList.add("d-none");
      e.target.textContent = "Ver menos";
    }
  }
});

loadOverview();
loadBySector();
loadByDay();
</script>

<footer class="text-center text-muted small mt-5">
  ⚡ Sistema de Chamados Institucionais — Plataforma Corporativa
</footer>
{% endblock %}
